<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ZIP Boundary Mapper — Multi‑Group</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
  <style>
    :root { --bg:#0b1020; --panel:#121a33; --muted:#8aa0c6; --accent:#7dd3fc; }
    * { box-sizing: border-box }
    body { margin:0; background:var(--bg); color:#e6eefb; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial }
    header { padding:14px 16px; border-bottom:1px solid #1c274a; display:flex; gap:12px; align-items:center; flex-wrap:wrap }
    h1 { font-size:16px; margin:0; font-weight:600 }
    .wrap { display:grid; grid-template-columns: 380px 1fr; height: calc(100vh - 54px) }
    @media (max-width: 920px){ .wrap { grid-template-columns: 1fr; grid-auto-rows: auto 1fr } }
    .panel { background:var(--panel); border-right:1px solid #1c274a; padding:14px; display:flex; flex-direction:column; gap:10px; overflow:auto }
    label { font-size:12px; color:var(--muted) }
    input[type="text"], input[type="color"], textarea { width:100%; border:1px solid #33406a; border-radius:10px; padding:9px 10px; background:#0e1530; color:#e6eefb; outline:none }
    textarea { min-height:72px; resize:vertical }
    .row { display:flex; gap:8px; flex-wrap:wrap }
    button, .toggle { cursor:pointer; border-radius:10px; border:1px solid #2d3b67; background:#182347; color:#e6eefb; padding:9px 12px; font-weight:600 }
    button.primary { background:#0e7cbf; border-color:#0b6ea8 }
    .small { font-size:12px; color: var(--muted) }
    .pill { font:12px/1.2 monospace; display:inline-block; padding:4px 8px; border:1px solid #2d3b67; border-radius:999px; background:#0e1530; margin-right:6px }
    #map { width:100%; height:100% }
    .legend { position:absolute; right:12px; bottom:12px; background:rgba(10,14,28,.9); border:1px solid #263257; border-radius:12px; padding:10px 12px; color:#c9d7f2; max-width:320px }
    .legend h3 { margin:0 0 6px 0; font-size:12px; text-transform:uppercase; letter-spacing:.08em; color:#9fb4dc }
    .legend .swatch { display:inline-block; width:14px; height:8px; background:#7dd3fc; margin-right:6px; vertical-align:middle; border-radius:2px }
    .notice { background:#0d142e; border:1px dashed #2b3a6b; padding:8px 10px; border-radius:10px; color:#b8c7ea }
    .footer { margin-top:auto; color:#9fb4dc; font-size:12px }
    a { color:#9ad7ff }

    .group-card { border:1px solid #2d3b67; border-radius:12px; padding:10px; background:#0f1836 }
    .group-head { display:flex; align-items:center; gap:8px; margin-bottom:8px }
    .chip { width:14px; height:14px; border-radius:4px; border:1px solid #2d3b67 }

    /* panes & labels */
    .leaflet-pane.pane-basemap{filter:grayscale(1) contrast(1.05) brightness(1.05); z-index:200 !important}
    .leaflet-pane.state-pane{z-index:400 !important}
    .leaflet-pane.zip-pane{z-index:650 !important}
    .leaflet-pane.labels-pane{z-index:700 !important}
    .group-label{ color:#000; font-weight:700 }
  </style>
</head>
<body>
  <header>
    <h1>ZIP Boundary Mapper — Multi‑Group</h1>
    <span class="pill">Data: Census ZCTA (2020)</span>
  </header>
  <div class="wrap">
    <aside class="panel">
      <div class="row" style="justify-content:space-between; align-items:center">
        <div class="small">Add one card per group. Give it a label, color, and list of ZIPs.</div>
        <button id="addGroup">+ Add group</button>
      </div>
      <div id="groups" style="display:flex; flex-direction:column; gap:12px"></div>

      <div class="row" style="margin-top:4px">
        <button id="plot" class="primary">Show all groups</button>
        <button id="clear">Clear map</button>
        <button id="sample">Load sample</button>
      </div>

      <div class="row" style="margin-top:4px">
        <button id="png">Download PNG</button>
        <label class="toggle"><input id="basemapToggle" type="checkbox" checked> Use basemap</label>
      </div>

      <div class="notice small">
        ZCTAs approximate USPS ZIP delivery areas. Good for mapping, not for legal boundaries. PNG export includes grayscale basemap, city labels, and your colored groups.
      </div>
      <div class="footer">Tip: paste messy lists; the app normalizes to five‑digit ZIPs.</div>
    </aside>

    <main style="position:relative">
      <div id="map"></div>
      <div class="legend" id="legend" hidden>
        <h3>Groups</h3>
        <div id="legendItems" style="display:grid; gap:4px"></div>
      </div>
    </main>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/leaflet-image/leaflet-image.js"></script>
  <script>
    // --- Config ---
    const CENSUS_ZCTA_LAYER = "https://tigerweb.geo.census.gov/arcgis/rest/services/TIGERweb/tigerWMS_ACS2022/MapServer/0"; // 2020 ZCTAs

    // --- Map ---
    const map = L.map('map', { zoomControl: true, renderer: L.canvas() }).setView([38.8048, -77.0469], 11);
    map.createPane('basemap'); map.getPane('basemap').classList.add('pane-basemap');
    map.createPane('state');   map.getPane('state').classList.add('state-pane');
    map.createPane('zip');     map.getPane('zip').classList.add('zip-pane');
    map.createPane('labels');  map.getPane('labels').classList.add('labels-pane');

    // CORS-friendly grayscale base + city labels
    const tiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19, attribution: 'Tiles \u00A9 Esri — Esri, HERE, Garmin, USGS, NGA, EPA, USDA, NPS', crossOrigin: 'anonymous', pane: 'basemap'
    }).addTo(map);
    const labelsTiles = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}', {
      maxZoom: 19, attribution: 'Labels \u00A9 Esri', crossOrigin: 'anonymous', pane: 'labels'
    }).addTo(map);

    // State outlines for context
    const stateLayer = L.geoJSON(null, { pane: 'state', style: () => ({ color: '#8aa0c6', weight: 1.2, fill: false, opacity: 0.9 }) }).addTo(map);
    (async function loadStates(){
      try {
        const STATE_URL = 'https://services.arcgis.com/P3ePLMYs2RVChkJx/arcgis/rest/services/USA_State_Boundaries/FeatureServer/0';
        const params = new URLSearchParams({ where: '1=1', outFields: 'NAME,STUSPS', returnGeometry: 'true', f: 'geojson' });
        const res = await fetch(`${STATE_URL}/query?${params.toString()}`); if (!res.ok) throw new Error('state query failed');
        stateLayer.addData(await res.json());
      } catch (err) { console.warn('State outlines failed to load', err); }
    })();

    const legendEl = document.getElementById('legend');
    const legendItems = document.getElementById('legendItems');

    // --- Groups model ---
    const vectorRenderer = L.canvas({ padding: 0.5 });
    const groups = new Map(); // id -> {id,label,color,opacity,zips, layer, labelMarker}
    let gid = 1;

    function parseZips(input) {
      return Array.from(new Set((input||'').replace(/\n/g,' ').split(/[^0-9]+/).map(z => z.trim()).filter(Boolean).map(z => z.padStart(5,'0'))));
    }

    function buildQuery(zips) {
      const list = zips.map(z => `'${z}'`).join(',');
      const params = new URLSearchParams({ where: `ZCTA5 IN (${list})`, outFields: '*', returnGeometry: 'true', f: 'geojson' });
      return `${CENSUS_ZCTA_LAYER}/query?${params.toString()}`;
    }

    function addGroupCard(opts={}){
      const id = opts.id || `g${gid++}`;
      const color = opts.color || randomPastel();
      const opacity = opts.opacity ?? 0.35;
      const label = opts.label || '';
      const zipsText = opts.zipsText || '';

      const card = document.createElement('div');
      card.className = 'group-card'; card.dataset.id = id;
      card.innerHTML = `
        <div class="group-head">
          <div class="chip" style="background:${color}"></div>
          <input type="text" class="g-label" placeholder="Group label (e.g., East Side)" value="${escapeHtml(label)}" />
          <button class="remove">Remove</button>
        </div>
        <div class="row">
          <label style="flex:1">Color<br/><input type="color" class="g-color" value="${color}"></label>
          <label style="flex:1">Opacity<br/><input type="range" class="g-opacity" min="0" max="1" step="0.05" value="${opacity}"></label>
        </div>
        <label>ZIP codes (comma or space separated)</label>
        <textarea class="g-zips" placeholder="e.g., 22301, 22302, 22314">${escapeHtml(zipsText)}</textarea>
      `;
      document.getElementById('groups').appendChild(card);

      // model entry
      groups.set(id, { id, color, opacity: parseFloat(opacity), label, zips: [], layer: null, labelMarker: null });

      // listeners
      card.querySelector('.g-color').addEventListener('input', (e)=>{
        card.querySelector('.chip').style.background = e.target.value;
        const g = groups.get(id); g.color = e.target.value; if (g.layer) g.layer.setStyle(groupStyle(g));
        renderLegend();
      });
      card.querySelector('.g-opacity').addEventListener('input', (e)=>{
        const g = groups.get(id); g.opacity = parseFloat(e.target.value); if (g.layer) g.layer.setStyle(groupStyle(g));
      });
      card.querySelector('.g-label').addEventListener('input', (e)=>{
        const g = groups.get(id); g.label = e.target.value; updateGroupLabelMarker(g); renderLegend();
      });
      card.querySelector('.remove').addEventListener('click', ()=> removeGroup(id));
    }

    function removeGroup(id){
      const card = document.querySelector(`.group-card[data-id="${id}"]`);
      if (card) card.remove();
      const g = groups.get(id);
      if (g){ if (g.layer) map.removeLayer(g.layer); if (g.labelMarker) map.removeLayer(g.labelMarker); groups.delete(id); }
      renderLegend();
    }

    function getCardData(id){
      const card = document.querySelector(`.group-card[data-id="${id}"]`);
      if (!card) return null;
      const label = card.querySelector('.g-label').value.trim();
      const color = card.querySelector('.g-color').value;
      const opacity = parseFloat(card.querySelector('.g-opacity').value);
      const zips = parseZips(card.querySelector('.g-zips').value);
      return { id, label, color, opacity, zips };
    }

    function groupStyle(g){ return { color: g.color, weight: 2, fill: true, fillColor: g.color, fillOpacity: g.opacity }; }

    function updateGroupLabelMarker(g){
      if (g.labelMarker){ map.removeLayer(g.labelMarker); g.labelMarker = null; }
      if (!g.layer || !g.label) return;
      const b = g.layer.getBounds(); if (!b.isValid()) return;
      const c = b.getCenter();
      g.labelMarker = L.marker([c.lat, c.lng], { pane: 'labels', interactive:false, opacity:0 })
        .bindTooltip(g.label, { permanent:true, direction:'center', className:'group-label' })
        .addTo(map);
    }

    async function plotAll(){
      let any = false; let bounds = null;
      for (const id of Array.from(groups.keys())){
        const data = getCardData(id); if (!data || !data.zips.length) continue;
        any = true; const url = buildQuery(data.zips);
        try {
          const res = await fetch(url); if (!res.ok) throw new Error('query failed');
          const gj = await res.json();
          // create or update layer
          let g = groups.get(id); if (!g) { g = { id }; groups.set(id, g); }
          // remove previous
          if (g.layer) map.removeLayer(g.layer);
          g.color = data.color; g.opacity = data.opacity; g.zips = data.zips; g.label = data.label;
          g.layer = L.geoJSON(gj, { renderer: vectorRenderer, pane: 'zip', style: groupStyle(g) }).addTo(map);
          updateGroupLabelMarker(g);
          // expand bounds
          const b = g.layer.getBounds();
          if (b.isValid()) bounds = bounds ? bounds.extend(b) : b;
        } catch(e){ console.error(e); alert(`Failed to load group ${id}. Try fewer ZIPs.`); }
      }
      if (!any) { alert('Add at least one group with ZIPs.'); return; }
      if (bounds && bounds.isValid()) map.fitBounds(bounds.pad(0.12));
      renderLegend();
    }

    function clearMap(){
      groups.forEach(g => { if (g.layer) map.removeLayer(g.layer); if (g.labelMarker) map.removeLayer(g.labelMarker); g.layer=null; g.labelMarker=null; });
      legendEl.hidden = true; legendItems.innerHTML = '';
    }

    function renderLegend(){
      const items = [];
      groups.forEach(g => {
        if (!g.layer) return;
        const count = (g.zips||[]).length;
        const label = g.label || '(no label)';
        items.push(`<div><span class="swatch" style="background:${g.color}"></span>${escapeHtml(label)} <span class="small">(${count} ZIPs)</span></div>`);
      });
      legendItems.innerHTML = items.join('');
      legendEl.hidden = items.length === 0;
    }

    function randomPastel(){
      const h = Math.floor(Math.random()*360); const s = 70; const l = 65; return `hsl(${h} ${s}% ${l}%)`;
    }

    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

    // --- UI events ---
    document.getElementById('addGroup').onclick = () => addGroupCard();
    document.getElementById('plot').onclick = () => plotAll();
    document.getElementById('clear').onclick = () => clearMap();
    document.getElementById('sample').onclick = () => {
      document.getElementById('groups').innerHTML = ''; groups.clear(); gid = 1;
      addGroupCard({ label:'Alexandria City Core', color:'#f472b6', opacity:0.40, zipsText:'22301, 22302, 22304, 22305, 22311, 22312, 22314' });
      addGroupCard({ label:'Alexandria Fairfax Fringe', color:'#34d399', opacity:0.35, zipsText:'22303, 22306, 22307, 22308, 22309, 22310, 22315' });
    };

    document.getElementById('basemapToggle').onchange = (e) => {
      if (e.target.checked){ tiles.addTo(map); labelsTiles.addTo(map); }
      else { map.removeLayer(tiles); map.removeLayer(labelsTiles); }
    };

    // --- Export PNG with basemap & labels ---
    function downloadBlob(filename, blob) {
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; document.body.appendChild(a); a.click(); a.remove(); setTimeout(() => URL.revokeObjectURL(a.href), 1000);
    }

    function waitForRender(timeoutMs = 1200) { return new Promise(resolve => { let done=false; const finish=()=>{ if(!done){done=true; resolve();}}; const t=setTimeout(finish, timeoutMs); const onIdle=()=>{ clearTimeout(t); finish(); }; if (map.hasLayer(tiles)) tiles.once('load', onIdle); else onIdle(); requestAnimationFrame(()=>requestAnimationFrame(()=>{})); }); }

    document.getElementById('png').onclick = async () => {
      const popup = window.open('', '_blank'); if (!popup) { alert('Allow popups to save the image.'); return; }
      try {
        await waitForRender(350);
        leafletImage(map, function(err, canvas){
          if (err || !canvas) { console.error(err); popup.close(); alert('PNG export failed'); return; }
          const out = document.createElement('canvas'); out.width = canvas.width; out.height = canvas.height;
          const ctx = out.getContext('2d'); ctx.fillStyle = '#0b1020'; ctx.fillRect(0,0,out.width,out.height); ctx.drawImage(canvas,0,0);
          let dataURL = '';
          try { dataURL = out.toDataURL('image/png'); } catch(e){ console.error('toDataURL blocked', e); popup.close(); alert('Browser blocked image export.'); return; }
          // Show & download
          popup.document.title = 'ZIP Boundary Export'; popup.document.body.style.margin='0';
          const img = popup.document.createElement('img'); img.src = dataURL; img.style.maxWidth='100%'; img.style.display='block'; popup.document.body.appendChild(img);
          const a = popup.document.createElement('a'); a.href = dataURL; a.download = 'zip-groups.png'; a.textContent = 'Click to download'; a.style.display='inline-block'; a.style.margin='12px'; a.style.padding='8px 12px'; a.style.border='1px solid #999'; popup.document.body.appendChild(a); a.click();
        });
      } catch(e){ console.error(e); popup.close(); alert('PNG export failed'); }
    };

    // boot with two sample groups
    document.getElementById('sample').click();
  </script>
</body>
</html>
